#!/bin/sh

# Usage: ./get_vscode_node_modules.sh <vscode version>
# Example: ./get_vscode_node_modules.sh 1.97.1

# shellcheck source=kaiju.conf
. kaiju.conf

# func
# die [what]
die () {
    _errc=$?
    if [ -n "$1" ]; then
        echo ">>> $1 failed ($_errc)"
    fi
    exit $_errc
}

_startdir=$(pwd)

if [ "$1" != "" ]; then
    _ver="$1"
else
    echo "Error: not set vscode version"
    echo "Usage: ./get_vscode_node_modules.sh <vscode version>"
	exit 1
fi

# get sources
if [ ! -f "$tools_workdir/vscode-${_ver}-download_done" ]; then
    cd "$tools_workdir" || die
    echo "Download distfile..."
    if [ ! -f "$distfiles/vscode-${_ver}.tar.gz" ]; then
         curl -L "https://github.com/microsoft/vscode/archive/${_ver}.tar.gz" \
              -o "$distfiles/vscode-${_ver}.tar.gz" \
              || die "curl vscode"
    fi
    cd "$_startdir" || die
    touch "$tools_workdir/vscode-${_ver}-download_done"
fi

# extract tarballs
if [ ! -f "$tools_workdir/vscode-${_ver}-extract_done" ]; then
    cd "$tools_workdir" || die
    echo "Extract distfiles..."
    if [ -d "vscode-netbsd-${_ver}" ]; then
        rm -rf "vscode-netbsd-${_ver}" || die
    fi
    mkdir -p "vscode-netbsd-${_ver}/vscode-node_modules-${_ver}" || die
    tar -xzf "$distfiles/vscode-${_ver}.tar.gz" --strip-components=1 -C "vscode-netbsd-${_ver}" || die "extract vscode"
    cd "$_startdir" || die
    touch "$tools_workdir/vscode-${_ver}-extract_done"
fi

# get node modules
if [ ! -f "$tools_workdir/vscode-${_ver}-getnode_done" ]; then
    cd "$tools_workdir/vscode-netbsd-${_ver}" || die
    _bd=$(pwd)
    npm install --ignore-scripts --no-progress --no-audit --no-fund || die "get main node modules"
    mv node_modules "vscode-node_modules-${_ver}/" || die
    for _subdir in $(node -p "JSON.stringify(require('./build/npm/dirs').dirs)" | jq -r '.[]'); do
        cd "$_subdir" || die
        npm install --ignore-scripts --no-progress --no-audit --no-fund || die "get $_subdir node modules"
        if [ -d node_modules ]; then
            mkdir -p "$_bd/vscode-node_modules-${_ver}/$_subdir" || die
            mv node_modules "$_bd/vscode-node_modules-${_ver}/$_subdir" || die
        fi
        cd "$_bd" || die
    done
    if [ -f "../vscode-node_modules-${_ver}.tar.gz" ]; then
        rm -f "../vscode-node_modules-${_ver}.tar.gz" || die
    fi
    tar -czf "../vscode-node_modules-${_ver}.tar.gz" "vscode-node_modules-${_ver}" || die "create tarball"
    cd "$_startdir" || die
    touch "$tools_workdir/vscode-${_ver}-getnode_done"
fi

# clean
if [ -f "$tools_workdir/vscode-${_ver}-getnode_done" ]; then
    rm "$tools_workdir/vscode-${_ver}-download_done"
    rm "$tools_workdir/vscode-${_ver}-extract_done"
    rm "$tools_workdir/vscode-${_ver}-getnode_done"
fi

exit 0
