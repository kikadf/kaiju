#!/bin/sh

# Usage: ./get_electron_node_modules.sh <electron version>
# Example: ./get_electron_node_modules.sh 32.3.2

# func
# die [what]
die () {
    _errc=$?
    if [ -n "$1" ]; then
        echo ">>> $1 failed ($_errc)"
    fi
    exit $_errc
}

_startdir=$(pwd)
_distfiles=/usr/pkgsrc/distfiles

if [ "$1" != "" ]; then
    _ver="$1"
else
    echo "Error: not set electron version"
    echo "Usage: ./get_electron_node_modules.sh <electron version>"
	exit 1
fi

_e_main=${_ver%%.*}

# get sources
if [ ! -f "../electron${_e_main}-${_ver}-download_done" ]; then
    cd .. || die
    echo "Download distfile..."
    if [ ! -f "$_distfiles/electron${_e_main}-${_ver}.tar.gz" ]; then
         curl -L "https://github.com/electron/electron/archive/v${_ver}.tar.gz" \
              -o "$_distfiles/electron${_e_main}-${_ver}.tar.gz" \
              || die "curl electron"
    fi
    cd "$_startdir" || die
    touch "../electron${_e_main}-${_ver}-download_done"
fi

# extract tarballs
if [ ! -f "../electron${_e_main}-${_ver}-extract_done" ]; then
    cd .. || die
    echo "Extract distfiles..."
    mkdir -p "electron${_e_main}-node-${_ver}/electron${_e_main}-node_modules-${_ver}" || die
    mkdir -p "electron${_e_main}-node-${_ver}/.ecache" || die
    tar -xzf "$_distfiles/electron${_e_main}-${_ver}.tar.gz" --strip-components=1 \
        -C "electron${_e_main}-node-${_ver}" || die "extract electron"
    cd "$_startdir" || die
    touch "../electron${_e_main}-${_ver}-extract_done"
fi

# get node modules
if [ ! -f "../electron${_e_main}-${_ver}-getnode_done" ]; then
    cd "../electron${_e_main}-node-${_ver}" || die
    _bd=$(pwd)
    echo "yarn-offline-mirror \"./electron${_e_main}-node_modules-${_ver}\"" >> .yarnrc
    HOME=${_bd} XDG_CACHE_HOME=${_bd}/.ecache yarn --frozen-lockfile --ignore-scripts
    mtree -cbnSp electron${_e_main}-node_modules-${_ver} | mtree -C | sed \
        -e 's:time=[0-9.]*:time=${YARN_TIMESTAMP}.000000000:' \
        -e 's:\([gu]id\)=[0-9]*:\1=0:g' \
        -e 's:mode=\([0-9]\)7[0-9][0-9]:mode=\1755:' \
        -e 's:mode=\([0-9]\)6[0-9][0-9]:mode=\1644:' \
        -e 's:flags=.*:flags=none:' \
        -e "s:^\.:./electron${_e_main}-node_modules-${_ver}:" > electron${_e_main}-node_modules-${_ver}.mtree
    tar -czf ../electron${_e_main}-node_modules-${_ver}.tar.gz \
        @electron${_e_main}-node_modules-${_ver}.mtree || die "create tarball"
    cd "$_startdir" || die
    touch "../electron${_e_main}-${_ver}-getnode_done"
fi

# clean
if [ -f "../electron${_e_main}-${_ver}-getnode_done" ]; then
    rm "../electron${_e_main}-${_ver}-download_done"
    rm "../electron${_e_main}-${_ver}-extract_done"
    rm "../electron${_e_main}-${_ver}-getnode_done"
fi

exit 0
